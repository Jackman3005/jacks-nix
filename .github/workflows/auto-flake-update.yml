name: Auto Flake Update

on:
  schedule:
    # Run every day at 8 PM UTC (6 AM AEST)
    - cron: '0 20 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-flake:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Nix
      uses: cachix/install-nix-action@v23
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Enable Nix flakes
      run: |
        echo "experimental-features = nix-command flakes" | sudo tee -a /etc/nix/nix.conf

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Auto Flake Update"

    - name: Run nix flake update
      run: |
        echo "ğŸ”„ Running nix flake update..."
        nix flake update

    - name: Check for changes and commit
      run: |
        if git diff --quiet flake.lock; then
          echo "â„¹ï¸  No changes to flake.lock - packages are already up to date"
          exit 0
        fi

        echo "ğŸ“ Changes detected in flake.lock, preparing to commit..."
        
        # Commit the changes
        echo "ğŸ’¾ Committing changes..."
        git add flake.lock
        git commit -m "chore: upgrade nix flake packages $(date +'%Y-%m-%d')"
        
        echo "ğŸ“¤ Pushing changes to remote repository..."
        git push
        
        echo "ğŸ‰ Successfully updated and pushed flake.lock!"