name: Test and Tag

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  checks:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v31.5.2
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Enable Nix flakes
      run: |
        echo "experimental-features = nix-command flakes" | sudo tee -a /etc/nix/nix.conf

    - name: Run tests
      run: cd bin && ./test-flake.sh

    - name: Upload test logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-logs
        path: bin/test-flake.log

  installs:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31.5.2
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Remove system nix.conf
        # Fix for nix-darwin wanting to override the system nix.conf, but it is present already.
        if: matrix.os == 'macos-latest'
        run: sudo mv /etc/nix/nix.conf /etc/nix/nix.conf.before-nix-darwin

      - name: Run install script
        run: cd bin && ./install.sh
        env:
          JACKS_NIX_CONFIG_REPO_PATH: "${{ github.workspace }}"
          JACKS_NIX_USERNAME: "runner"
#          JACKS_NIX_MAC_NIXBLD_GROUP_ID: "30000"
#          JACKS_NIX_MAC_NIXBLD_USER_ID: "300"
          JACKS_NIX_ENABLE_HOMEBREW: "false" # Would be great to enable, but `system.primaryUser` is not working
          NIX_CONFIG: "access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}"

      - name: Calculate closure size
        run: |
          if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            FLAKE_OUTPUT=".#darwinConfigurations.mac-arm64.system"
            SIZE_KEY="mac_arm64"
          else
            FLAKE_OUTPUT=".#homeConfigurations.linux-x64.activationPackage"
            SIZE_KEY="linux_x64"
          fi

          SIZE_BYTES=$(nix path-info -S "$FLAKE_OUTPUT" 2>/dev/null | awk '{print $2}')
          echo "${SIZE_KEY}_bytes=${SIZE_BYTES}" > closure-size.txt
          echo "Closure size for ${SIZE_KEY}: ${SIZE_BYTES} bytes"

      - name: Upload closure size
        uses: actions/upload-artifact@v4
        with:
          name: closure-size-${{ matrix.os }}
          path: closure-size.txt
          retention-days: 1

  changelog-and-tag:
    needs:
      - checks
      - installs
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      actions: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.JACKS_NIX_GH_PAT }}

    - name: Install Nix
      uses: cachix/install-nix-action@v31.5.2
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Enable Nix flakes
      run: |
        echo "experimental-features = nix-command flakes" | sudo tee -a /etc/nix/nix.conf

    - name: Setup Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@v8

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Changelog"

    - name: Install nvd for package diff
      run: nix profile install nixpkgs#nvd

    - name: Download closure size artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: closure-size-*
        path: size-artifacts

    - name: Set closure size environment variables
      run: |
        if [[ -f size-artifacts/closure-size-ubuntu-latest/closure-size.txt ]]; then
          source size-artifacts/closure-size-ubuntu-latest/closure-size.txt
          echo "LINUX_X64_BYTES=$linux_x64_bytes" >> $GITHUB_ENV
          echo "Linux closure size: $linux_x64_bytes bytes"
        fi
        if [[ -f size-artifacts/closure-size-macos-latest/closure-size.txt ]]; then
          source size-artifacts/closure-size-macos-latest/closure-size.txt
          echo "MAC_ARM64_BYTES=$mac_arm64_bytes" >> $GITHUB_ENV
          echo "macOS closure size: $mac_arm64_bytes bytes"
        fi

    - name: Generate changelog
      env:
        NIX_CONFIG: "access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}"
      run: ./bin/generate-changelog.sh

    - name: Commit changelog and tag
      run: |
        git add VERSION changelogs/

        # Only commit if there are staged changes, use [skip ci] to prevent circular triggers
        if ! git diff --staged --quiet; then
          git commit -m "v$(cat VERSION): changelog [skip ci]"
          git push https://x-access-token:${{ secrets.JACKS_NIX_GH_PAT }}@github.com/${{ github.repository }}.git HEAD:main
        fi

        VERSION=$(cat VERSION)

        # Create permanent version tag (e.g., v297)
        git tag "v${VERSION}"
        git push https://x-access-token:${{ secrets.JACKS_NIX_GH_PAT }}@github.com/${{ github.repository }}.git "v${VERSION}" || true

        # Update the moving 'latest' tag
        git tag -d latest 2>/dev/null || true
        git push https://x-access-token:${{ secrets.JACKS_NIX_GH_PAT }}@github.com/${{ github.repository }}.git :refs/tags/latest || true

        git tag latest
        git push https://x-access-token:${{ secrets.JACKS_NIX_GH_PAT }}@github.com/${{ github.repository }}.git latest
